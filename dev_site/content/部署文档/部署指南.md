---
title: "部署指南"
date: 2018-06-21T14:10:38+08:00
draft: false
---

- [编译服务](#)
- [第三方服务的部署](#)
    - [部署 consul](#consul)
        - [说明](#)
        - [下载安装](#)
        - [部署](#)
            - [部署数量](#)
            - [创建配置文件](#)
            - [启动命令](#)
    - [部署 NSQ](#nsq)
        - [服务说明](#)
        - [安装](#)
        - [启动](#)
            - [NSQLOOKUPD](#nsqlookupd)
            - [NSQD](#nsqd)
    - [部署 REDIS](#redis)
        - [说明](#)
        - [安装](#)
        - [配置](#)
        - [启动](#)
- [应用服务的部署](#)
    - [通用配置项](#)
    - [部署 gateway 服务](#gateway)
        - [服务说明](#)
        - [通用配置项](#)
        - [特有配置项](#)
        - [部署方式](#)
            - [部署数量](#)
            - [负载均衡](#)
            - [启动方式](#)
    - [部署 room 服务](#room)
        - [服务说明](#)
        - [通用配置项](#)
        - [特殊配置项](#)
        - [部署方式](#)
            - [部署数量](#)
            - [启动方式](#)
    - [部署 login 服务](#login)
        - [服务说明](#)
        - [通用配置项](#)
        - [特殊配置项](#)
        - [部署方式](#)
            - [部署数量](#)
            - [启动方式](#)
    - [部署 match 服务](#match)
        - [服务说明](#)
        - [通用配置项](#)
        - [部署方式](#)
            - [部署数量](#)
            - [启动方式](#)
    - [部署 hall 服务](#hall)
        - [服务说明](#)
        - [通用配置项](#)
        - [部署方式](#)
            - [部署数量](#)
            - [启动方式](#)

注意事项：

* 文档中列出的所有地址，除特殊说明外，均不需要能够让客户端访问

# 编译服务

* 如果以二进制方式提供服务模块，跳过此步骤
* 安装 serviceloader 
 
    ```
    go install steve/serviceloader
    ``` 

* 编译 room 服务

    ```
    cd $GOPATH/steve/room
    go build -buildmode=plugin
    ```

* 编译 gateway 服务

    ```
    cd $GOPATH/steve/gateway
    go build -buildmode=plugin
    ```

* 编译 login 服务

    ```
    cd $GOPATH/steve/login
    go build -buildmode=plugin
    ```

* 编译 hall 服务
    
    ```
    cd $GOPATH/steve/hall 
    go build -buildmode=plugin
    ```

----------

# 第三方服务的部署


## 部署 consul 

### 说明

* 作为服务发现系统

* 用于应用层配置文件

### 下载安装

* 使用版本： 1.1.0
* 安装方法参考官方网址： https://www.consul.io/intro/getting-started/install.html 

### 部署

#### 部署数量

* 生产环境和测试环境
    * 应该为每台服务机器启动 1 个 consul agent （暂定，具体还在查询资料）
    * 应该有 3-5 个 consul agent 使用 server 模式启动
* 开发环境通常使用 dev 模式部署 1 个代理

#### 创建配置文件

* consul 的配置文件是 json 格式的
* 创建配置文件目录

    ```
    mkdir /opt/consul/conf
    ```
* 按照需求编辑配置文件 config.json，保存到配置文件目录中。

    ```
    {
        "datacenter": "dc1",              # 该标记控制agent的datacenter的名称，默认是dc1
        "data_dir": "/opt/consul/data",   # 提供一个目录用来存放agent的状态，所有的agent都需要该目录，该目录必须是稳定的，系统重启后都继续存在。
        "log_level": "INFO",              # 日志级别
        "server": true,                   # 是否以 server 模式启动
        "bootstrap_expect": 1,            # 在一个datacenter中期望提供的server节点数目，当该值提供的时候，consul一直等到达到指定sever数目的时候才会引导整个集群
        "bind_addr": "192.168.2.210",     # 该地址用来在 consul 集群内部的通讯，集群内的所有节点到地址都必须是可达的，默认是 0.0.0.0
        "client_addr": "192.168.2.210",   # consul绑定在哪个 client 地址上，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1
        "ui_dir": "/opt/consul/web",      # 提供存放web ui资源的路径，该目录必须是可读的。
        "retry_join": ["192.168.2.210","192.168.2.211","192.168.2.212"],  # 加入一个已经启动的agent的ip地址，可以多次指定多个agent的地址。 如果指定的地址都没有启动，会一直重试。
        "retry_interval": "30s",          # 重试间隔时间
        "enable_syslog": true,            # 开启系统日志功能，只在linux/osx上生效
        "syslog_facility": "local0"       # 当enable_syslog被提供后，该参数控制哪个级别的信息被发送，默认Local0。
    }
    ```

#### 启动命令

* 普通模式启动

    ```
    consul agent -config-dir /opt/consul/conf/
    ```

* 开发模式启动

    ```
    consul agent -dev
    ```


----------

## 部署 NSQ

### 服务说明

* 消息队列

### 安装 

* 使用版本 v1.0.0-compat

* 具体安装方式参考: https://nsq.io/deployment/installing.html

### 启动

#### NSQLOOKUPD

* 在生产环境和测试环境下，启动 3-4 个 nsqlookupd 进程， 并且分别部署在不同的机器上
* 在开发环境下，可以只启动 1 个 nsqlookupd 进程
* 启动方式： 

    ```  
    # http-address 表示提供 http 服务的地址。
    # tcp-address 表示提供 tcp 服务的地址
    nsqlookupd --http-address 0.0.0.0:4161 --tcp-address 0.0.0.0:4160
    ```

#### NSQD

* 在生产环境和测试环境下，为每个应用服务启动一个 nsqd 进程
* 在开发环境下，可以只启动 1 个 nsqd 进程
* 启动方式为： 

    ```
    # lookupd-tcp-address 表示 NSQLOOKUPD 的监听地址， 
    # 有多少个 NSQLOOKUPD 进程，就需要配置多少个
    # http-address 表示提供 http 服务的地址
    # tcp-address 表示提供 tcp 服务的地址
    nsqd --lookupd-tcp-address 192.168.8.200 \
        --lookupd-tcp-address 192.168.8.201 \
        --lookupd-tcp-address 192.168.8.202 \
        --http-address 0.0.0.0:4151 --tcp-address 0.0.0.0:4150
    ```

------------

## 部署 REDIS

### 说明

* 作为数据缓存
* 暂时使用独立模式启动，后续可能会使用集群模式

### 安装 

* 使用版本 4.0

* 安装方式： 

    ```
    wget http://download.redis.io/releases/redis-4.0.10.tar.gz
    tar xzf redis-4.0.10.tar.gz
    cd redis-4.0.10
    make install 

    # 创建 redis 配置目录
    sudo mkdir /etc/redis/
    # 将默认配置文件拷贝到配置目录
    sudo cp redis.conf /etc/redis/
    ```

### 配置

* 修改 /etc/redis/redis.conf 中的 bind 为要监听的 IP 地址
* 修改 /etc/redis/redis.conf 中的 port 为要监听的端口

### 启动


* 启动命令：
    ```
    redis-server /etc/redis/redis.conf 
    ```


# 应用服务的部署

## 通用配置项

* 配置采用 yaml 格式， 每个服务会单独提供配置模板
* 下面是所有服务公用的配置项： 

配置项 | 类型 | 作用 | 默认值 | 示例 |备注 
----- | ---- |-------- | ----- | ----- | ------
log_level | string | log日志等级 | info | debug|  可取值为 debug, info, warning, error, fatal, panic
log_dir   | string | log日志目录 | 空| ./log |为空时不记录日志文件 
log_file | string | log日志文件名前缀 | 空 | mylog | 实际的log日志文件为 prefix_年_月_日_时.log， 为空时不记录日志 
log_stderr | bool | 是否输出日志到标准错误 | true | true | 和输出到文件互不影响，可以同时输出标准错误和文件
rpc_addr | string | 提供的 rpc 服务 IP | 空 | 192.168.9.201 |  有部分服务不提供 rpc 服务， 不需要配置此项
rpc_port | int | 提供 rpc 服务的 端口 | 0 | 36002 | 有部分服务不提供 rpc 服务，不需要配置此项
rpc_server_name | string | 提供的 rpc 服务名称 | 空 | gate | 有部分服务不提供 rpc 服务，不需要配置此项。 该值的具体配置由  [通用配置](/部署文档/部署指南/) 给出
consul_addr | string | consul agent 的地址 | 127.0.0.1:8500 | 192.168.9.201:8500 | 
nsq_addr | string | nsqd 监听的 tcp 地址 |  127.0.0.1:4150 | 192.168.9.201:4150 | 
nsqlookupd_addrs | list | nsqlookupd 的 HTTP 监听地址 | 127.0.0.1:4161 | 192.168.9.201:4161 192.168.9.201:4162 | 需要用 yaml 格式配置所有的 nsqlookupd http 地址
redis_addr | string | redis 服务地址 | 127.0.0.1:6379  | 192.168.9.201:6379 | 部分服务不需要配置此项。具体由[通用配置](/部署文档/部署指南/) 说明
redis_passwd | string | redis 密码 | 空 | 123456 | 部分服务不需要配置此项。具体由[通用配置](/部署文档/部署指南/) 说明

----------------

## 部署 gateway 服务

### 服务说明

* 用来维护和客户端的长连接，包括连接和玩家数据的映射关系，心跳检测等功能
* 转发客户端发来的消息到各个服务器
* 转发服务器的消息到客户端

### 通用配置项
* rpc_server_name 配置为 gate 

### 特有配置项

配置项 | 类型 | 作用 | 默认值 | 示例 |备注 
----- | ---- |-------- | ----- | ----- | ------
lis_client_addr | string | 监听客户端的地址 | 127.0.0.1 | 0.0.0.0 | 需要能够让客户端连接
lis_client_port | int | 监听客户端的端口 | 36001 | 36001 | 需要能够让客户端连接
lis_client_addr_inquire | string | 客户端连接地址 | 127.0.0.1 | 78.58.21.35 | 客户端连接的地址，注意和监听地址的区别 


### 部署方式

#### 部署数量

* 在生产环境中，应该根据玩家数量，部署多个 gateway 服务， 部署数量和玩家数量的比例关系待测试
* 在测试环境和开发环境中，建议部署 1 个 gateway 服务

#### 负载均衡

* 可以部署第三方负载均衡服务
* 具体流程待完善 

#### 启动方式

* 使用 serviceloader 启动 gateway 服务

    ```
    # 需要在 gateway.so 所在目录启动
    # config 对应配置路径
    serviceloader gateway --config=config.yml
    ```

-----------------

## 部署 room 服务

### 服务说明

* 提供牌桌服务，如创建房间
* 管理牌桌，记录牌桌信息，和客户端进行牌桌信息交互等
* 处理行牌逻辑

### 通用配置项

* rpc_server_name 配置为 room

### 特殊配置项

配置项 | 类型 | 作用 | 默认值 | 示例 |备注 
----- | ---- |-------- | ----- | ----- | ------
peipai_addr | string | 内网测试配牌地址 | 127.0.0.1:36102 | 0.0.0.0:36102 | 测试环境需要支持外部访问，生产环境不能支持外部访问


### 部署方式

#### 部署数量

* 在生产环境中，应该根据玩家数量，部署多个 room 服务， 部署数量和玩家数量的比例关系待测试
* 在测试环境中，建议部署 2 个 room 服务
* 在开发环境中，建议部署 1 个 room 服务

#### 启动方式

* 使用 serviceloader 启动 room 服务

    ```
    # 需要在 room.so 所在目录启动
    # config 对应配置路径
    serviceloader room --config=config.yml
    ```

------------------


## 部署 login 服务

### 服务说明

* 提供登录相关服务
* 创建游戏用户初始数据

### 通用配置项

* rpc_server_name 配置成 login 

### 特殊配置项

配置项 | 类型 | 作用 | 默认值 | 示例 |备注 
----- | ---- |-------- | ----- | ----- | ------
lis_client_addr | string | 监听客户端的地址 | 127.0.0.1 | 0.0.0.0 | 需要能够让客户端连接
lis_client_port | int | 监听客户端的端口 | 36201 | 36201 | 需要能够让客户端连接


### 部署方式

#### 部署数量

* 在生产环境中，应该根据玩家数量，部署多个 login 服务， 部署数量和玩家数量的比例关系待测试
* 在测试环境，建议部署 2 个 login 服务
* 在开发环境，建议部署 1 个 login 服务

#### 启动方式

* 使用 serviceloader 启动 login 服务

    ```
    # 需要在 login.so 所在目录启动
    # config 对应配置路径
    serviceloader login --config=config.yml
    ```


---------------------

## 部署 match 服务

### 服务说明

* 处理玩家匹配请求
* 执行匹配逻辑，通知 room 创建房间

### 通用配置项

* rpc_server_name 配置为 match

### 部署方式

#### 部署数量

* 部署 1 个 match 服务

#### 启动方式

* 使用 serviceloader 启动 match 服务

    ```
    # 需要在 match.so 所在目录启动
    # config 对应配置路径
    serviceloader match --config=config.yml
    ```

------------------



---------------------

## 部署 hall 服务

### 服务说明

* 提供一些通用的服务，如玩家信息获取，场次信息获取等

### 通用配置项

* rpc_server_name 配置为 hall

### 部署方式

#### 部署数量

* 部署 1 个 hall 服务

#### 启动方式

* 使用 serviceloader 启动 hall 服务

    ```
    # 需要在 hall.so 所在目录启动
    # config 对应配置路径
    serviceloader hall --config=config.yml
    ```

------------------