---
title: "麻将玩法逻辑框架设计说明"
date: 2018-04-17T10:10:38+08:00
draft: false
---

# 麻将玩法逻辑框架设计说明

我们有很多的麻将玩法，各个玩法之间有很多相同的逻辑，但同时也有很多的差异性。这就对我们的麻将玩法框架设计提出了挑战，我们的目标是：

* 复用相同的逻辑

如果某个部分的逻辑出了问题，我们希望只修复着这一个部分，然后其他复用这部分代码逻辑的游戏就全部修复。这就意味着我们不能通过复制代码的方法来复用逻辑。

例如我们已经在血流麻将玩法中开发了碰的逻辑，那么我们希望这个碰的逻辑的代码，能够在其他有相同逻辑的麻将玩法里直接复用，而不是通过复制一份碰的代码来复用。

*  避免新需求，新特性，新玩法影响已有逻辑的部分

如果我们有个新的麻将玩法，它也有碰的逻辑，但是在这个玩法里它的逻辑有一定的不同，比如：新玩法里的碰逻辑只允许碰对家的牌。 那么对于这种情况我们不能复用过去的代码，而是需要重新开发一个碰的逻辑。如果复用过去的代码，意味着我们必须修改原来的代码逻辑，这就可能把过去正确的逻辑改出错误。所以对于这种情况必须不修改过去的逻辑，而是新增逻辑。


基于上面的目标，我们的麻将框架设计成一个类似搭积木的方案。它由下面几个部分组成：

* MajongLogicFlow: 麻将逻辑流程描述
* ActionNode: 麻将动作逻辑处理节点
* Edge: 连接麻将节点
* LogicComponent: 麻将行牌逻辑实现接口定义
* ScoreComponent: 麻将算翻逻辑实现接口定义

## MajongLogicFlow: 麻将逻辑流程描述 

MajongLogicFlow 记录了一个麻将玩法的整体逻辑流程，每个玩法都有一个自己独立的 MajongLogicFlow，它通过创建 ActionNode 节点，用 Edge 连接 ActionNode 来进行描述。

MajongLogicFlow 主要有下面几个方法：

* PushActionNode(ctx context.Context, actionNode ActionNode)

添加一个 ActionNode 到 MajongLogicFlow 。


* PushEdge(ctx context.Context,edge Edge)
* ProcessNode((ctx context.Context, records Records, action Action)



![四川血流麻将逻辑流程图](/新手指南/files/四川血流.png) 

## Node: 麻将逻辑处理节点