---
title: "麻将玩法逻辑框架设计说明"
date: 2018-04-17T10:10:38+08:00
draft: false
---

版本：0.0.9

本文主要描述设计思想，文内的代码可能和实际实现不符，实现方式以实际代码为准。


# 概述

我们有很多的麻将玩法，各个玩法之间有很多相同的逻辑，但同时也有很多的差异性。这就对我们的麻将玩法框架设计提出了挑战，我们的目标是：

* 复用相同的逻辑

如果某个部分的逻辑出了问题，我们希望只修复着这一个部分，然后其他复用这部分代码逻辑的游戏就全部修复。这就意味着我们不能通过复制代码的方法来复用逻辑。

例如我们已经在血流麻将玩法中开发了碰的逻辑，那么我们希望这个碰的逻辑的代码，能够在其他有相同逻辑的麻将玩法里直接复用，而不是通过复制一份碰的代码来复用。

*  避免新需求，新特性，新玩法影响已有逻辑的部分

如果我们有个新的麻将玩法，它也有碰的逻辑，但是在这个玩法里它的逻辑有一定的不同，比如：新玩法里的碰逻辑只允许碰对家的牌。 那么对于这种情况我们不能复用过去的代码，而是需要重新开发一个碰的逻辑。如果复用过去的代码，意味着我们必须修改原来的代码逻辑，这就可能把过去正确的逻辑改出错误。所以对于这种情况必须不修改过去的逻辑，而是新增逻辑。

* 代码简洁，逻辑清晰，易于人类阅读

麻将的逻辑比较复杂，我们尝试过用每个玩家一个状态机的方法来描述，也尝试过用一个状态机来描述。但是面临的问题都是不易理解，不够直观。后来发现基于玩家操作事件的先后关系，可以把麻将描述成一个图，因此我们在这个基础上设计成一个动作流程图，但实质是状态机的实现。

当我们实现完成一个麻将玩法后，这个玩法可以生成一个类似下面的流程图。


![四川血流麻将逻辑流程图](/新手指南/files/四川血流.png) 


# 术语表

* Event： 事件，有玩家事件，系统事件两种来源。一个玩家客户端发了一个碰的请求给服务器，那么这个请求就可以视为一个碰的事件。
* State： 状态，麻将牌局里的状态。

# 麻将模块组成部分

它由下面几个部分组成：

* MajongLogicFlow: 麻将逻辑流程描述
* ActionNode: 麻将动作逻辑处理节点
* Edge: 连接麻将节点
* LogicComponent: 麻将行牌逻辑实现接口定义
* ScoreComponent: 麻将算翻逻辑实现接口定义

## MajongLogicFlow: 麻将逻辑流程描述 

MajongLogicFlow 记录了一个麻将玩法的整体逻辑流程，每个玩法都有一个自己独立的 MajongLogicFlow，它通过创建 ActionNode 节点，用 Edge 连接 ActionNode 来进行描述。



MajongLogicFlow 主要有下面几个方法：

* PushActionNode(ctx context.Context, actionNode ActionNode) error

添加一个 ActionNode 到 MajongLogicFlow 。


* PushEdge(ctx context.Context,edge Edge)

给添加到 MajongLogicFlow 的 ActionNode 建立连接关系

* ProcessActionNode(ctx context.Context, records Records, action Action) (Response, error)

1. 首先根据 ActionID 找出 ActionNode
2. 从 Records 里取出上一个 Last Critical Action Node
3. 根据 Last Critical Action Node 判断是否当前这个 ActionID 可以被执行
4. 如果可以被执行，则按照下面的顺序调用 ActionNode 的方法

> 1. Valid(ctx context.Context, records Records, action Action) bool
> 2. BeforeProcessAction(ctx context.Context, records Records, action Action) (Records)
> 3. ProcessAction(ctx context.Context, records Records, action Action) (Records, Response, [] ActionNode, error)
> 4. AfterProcessAction(ctx context.Context, records Records, action Action) (Records)
> 5. BeforeProcessSettle(ctx context.Context, records Records, action Action) (Records)
> 6. ProcessSettle(ctx context.Context, records Records, action Action) (Records, Response, [] ActionNode, error)
> 7. AfterProcessSettle(ctx context.Context, records Records, action Action) (Records)
> 8. BeforeSetStates(ctx context.Context, records Records, action Action) (Records)
> 9. SetStates(ctx context.Context, records Records, action Action) (Records, Response, [] ActionNode, error)
> 10. AfterSetStates(ctx context.Context, records Records, action Action) (Records)



* BindCriticalActionNodeSetter(CriticalActionNodeSetter)


## Node: 麻将逻辑处理节点